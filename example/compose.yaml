# This file is generated by Castor. Do not edit it manually.
name: castor-docker-demo
volumes:
    postgres_data: {  }
    mysql-data: {  }
    rabbitmq-data: {  }
    redis-data: {  }
    redis-insight-data: {  }
    elasticsearch-data: {  }
services:
    router:
        build: /home/joelwurtz/Workspace/OpenSource/castor-docker/src/Service/../Resources/router
        volumes:
            - '/var/run/docker.sock:/var/run/docker.sock'
            - '.home:/home/app:cached'
        ports:
            - '80:80'
            - '443:443'
            - '8080:8080'
        profiles:
            - router
    postgres:
        image: 'postgres:16'
        environment:
            POSTGRES_USER: app
            POSTGRES_PASSWORD: app
        volumes:
            - 'postgres_data:/var/lib/postgresql/data'
        healthcheck:
            test:
                - CMD-SHELL
                - 'pg_isready -U app'
            interval: 5s
            timeout: 5s
            retries: 5
    mysql:
        image: 'mysql:8'
        environment:
            MYSQL_ALLOW_EMPTY_PASSWORD: '1'
        volumes:
            - 'mysql-data:/var/lib/mysql'
        healthcheck:
            test: 'mysqladmin ping -h localhost'
            interval: 5s
            timeout: 5s
            retries: 5
    app1:
        build:
            context: /home/joelwurtz/Workspace/OpenSource/castor-docker/src/Service/../Resources/php
            target: frontend
            cache_from:
                - 'type=registry,ref=${REGISTRY:-}/app1:cache'
            args:
                PHP_VERSION: '8.5'
        user: '1000:1000'
        volumes:
            - '/home/joelwurtz/Workspace/OpenSource/castor-docker/example/app1:/var/www:cached'
            - '.home:/home/app:cached'
        profiles:
            - default
        labels:
            - traefik.enable=true
            - 'traefik.http.routers.castor-docker-demo-app1.rule=Host(`app1.project.test`) || Host(`project.test`) || Host(`localhost`)'
            - traefik.http.routers.castor-docker-demo-app1.entrypoints=https
            - traefik.http.routers.castor-docker-demo-app1.tls=true
            - 'traefik.http.routers.castor-docker-demo-app1-unsecure.rule=Host(`app1.project.test`) || Host(`project.test`) || Host(`localhost`)'
            - traefik.http.services.castor-docker-demo-app1.loadbalancer.server.port=80
        depends_on:
            postgres:
                condition: service_healthy
        environment:
            - 'DATABASE_URL=postgresql://app:app@postgres:5432/app?serverVersion=16&charset=utf8'
    app1-builder:
        build:
            context: /home/joelwurtz/Workspace/OpenSource/castor-docker/src/Service/../Resources/php
            target: builder
            cache_from:
                - 'type=registry,ref=${REGISTRY:-}/app1-builder:cache'
            args:
                PHP_VERSION: '8.5'
        user: '1000:1000'
        init: true
        volumes:
            - '/home/joelwurtz/Workspace/OpenSource/castor-docker/example/app1:/var/www:cached'
            - '.home:/home/app:cached'
        profiles:
            - builder
        depends_on:
            postgres:
                condition: service_healthy
        environment:
            - 'DATABASE_URL=postgresql://app:app@postgres:5432/app?serverVersion=16&charset=utf8'
    app2:
        build:
            context: /home/joelwurtz/Workspace/OpenSource/castor-docker/src/Service/../Resources/php
            target: frontend
            cache_from:
                - 'type=registry,ref=${REGISTRY:-}/app2:cache'
            args:
                PHP_VERSION: '8.2'
        user: '1000:1000'
        volumes:
            - '/home/joelwurtz/Workspace/OpenSource/castor-docker/example/app2:/var/www:cached'
            - '.home:/home/app:cached'
        profiles:
            - default
        labels:
            - traefik.enable=true
            - traefik.http.routers.castor-docker-demo-app2.rule=Host(`app2.project.test`)
            - traefik.http.routers.castor-docker-demo-app2.entrypoints=https
            - traefik.http.routers.castor-docker-demo-app2.tls=true
            - traefik.http.routers.castor-docker-demo-app2-unsecure.rule=Host(`app2.project.test`)
            - traefik.http.services.castor-docker-demo-app2.loadbalancer.server.port=80
            - traefik.http.routers.castor-docker-demo-app2.middlewares=redirect-to-https@file
        depends_on:
            mysql:
                condition: service_healthy
        environment:
            - 'DATABASE_URL=mysql://app:app@mysql:3306/app'
    app2-builder:
        build:
            context: /home/joelwurtz/Workspace/OpenSource/castor-docker/src/Service/../Resources/php
            target: builder
            cache_from:
                - 'type=registry,ref=${REGISTRY:-}/app2-builder:cache'
            args:
                PHP_VERSION: '8.2'
        user: '1000:1000'
        init: true
        volumes:
            - '/home/joelwurtz/Workspace/OpenSource/castor-docker/example/app2:/var/www:cached'
            - '.home:/home/app:cached'
        profiles:
            - builder
        depends_on:
            mysql:
                condition: service_healthy
        environment:
            - 'DATABASE_URL=mysql://app:app@mysql:3306/app'
    rabbitmq:
        build: /home/joelwurtz/Workspace/OpenSource/castor-docker/src/Service/../Resources/rabbitmq
        volumes:
            - 'rabbitmq-data:/var/lib/rabbitmq'
        labels:
            - traefik.enable=true
            - traefik.http.routers.castor-docker-demo-rabbitmq.rule=Host(`rabbitmq.castor-docker-demo.test`)
            - traefik.http.routers.castor-docker-demo-rabbitmq.tls=true
            - traefik.http.services.rabbitmq.loadbalancer.server.port=15672
        healthcheck:
            test: "rabbitmqctl eval '{ true, rabbit_app_booted_and_running } = { rabbit:is_booted(node()), rabbit_app_booted_and_running }, { [], no_alarms } = { rabbit:alarms(), no_alarms }, [] /= rabbit_networking:active_listeners(), rabbitmq_node_is_healthy.' || exit 1"
            interval: 5s
            timeout: 5s
            retries: 5
        profiles:
            - default
    redis:
        image: 'redis:5'
        healthcheck:
            test:
                - CMD
                - redis-cli
                - ping
            interval: 5s
            timeout: 5s
            retries: 5
        volumes:
            - 'redis-data:/data'
        profiles:
            - default
    redis-insight:
        image: redislabs/redisinsight
        volumes:
            - 'redis-insight-data:/db'
        labels:
            - traefik.enable=true
            - traefik.http.routers.castor-docker-demo-redis.rule=Host(`redis.castor-docker-demo.test`)
            - traefik.http.routers.castor-docker-demo-redis.tls=true
        profiles:
            - default
    elasticsearch:
        image: 'elasticsearch:7.8.0'
        volumes:
            - 'elasticsearch-data:/usr/share/elasticsearch/data'
        environment:
            - discovery.type=single-node
        labels:
            - traefik.enable=true
            - traefik.http.routers.castor-docker-demo-elasticsearch.rule=Host(`elasticsearch.castor-docker-demo.test`)
            - traefik.http.routers.castor-docker-demo-elasticsearch.tls=true
        healthcheck:
            test:
                - CMD-SHELL
                - 'curl --fail http://localhost:9200/_cat/health || exit 1'
            interval: 5s
            timeout: 5s
            retries: 5
        profiles:
            - default
    kibana:
        image: 'kibana:7.8.0'
        depends_on:
            - elasticsearch
        labels:
            - traefik.enable=true
            - project-name=castor-docker-demo
            - traefik.http.routers.castor-docker-demo-kibana.rule=Host(`kibana.castor-docker-demo.test`)
            - traefik.http.routers.castor-docker-demo-kibana.tls=true
        profiles:
            - default
include:
    - compose.override.yaml
